name: Code Quality

on:
    pull_request:
        branches: [main, develop]
    push:
        branches: [main, develop]

jobs:
    code-quality:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Check Indentation
              run: |
                  echo "üîç Checking file indentation..."

                  # Check HTML, CSS, JS files for 4-space indentation
                  files=$(find . -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) \
                          -not -path "./node_modules/*" \
                          -not -path "./.git/*")

                  has_tab=false

                  for file in $files; do
                    if grep -qP '\t' "$file"; then
                      echo "‚ùå File contains tabs instead of spaces: $file"
                      has_tab=true
                    fi
                  done

                  if [ "$has_tab" = true ]; then
                    echo "‚ùå Indentation check failed! Use 4 spaces instead of tabs."
                    exit 1
                  fi

                  echo "‚úÖ Indentation check passed!"

            - name: Check Line Endings
              run: |
                  echo "üîç Checking line endings (LF)..."

                  files=$(find . -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.md" \) \
                          -not -path "./node_modules/*" \
                          -not -path "./.git/*")

                  has_crlf=false

                  for file in $files; do
                    if file "$file" | grep -q "CRLF"; then
                      echo "‚ùå File has CRLF line endings: $file"
                      has_crlf=true
                    fi
                  done

                  if [ "$has_crlf" = true ]; then
                    echo "‚ùå Line ending check failed! Use LF (Unix) line endings."
                    exit 1
                  fi

                  echo "‚úÖ Line ending check passed!"

            - name: Check Trailing Whitespace
              run: |
                  echo "üîç Checking for trailing whitespace..."

                  files=$(find . -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) \
                          -not -path "./node_modules/*" \
                          -not -path "./.git/*")

                  has_trailing=false

                  for file in $files; do
                    if grep -q '[[:space:]]$' "$file"; then
                      echo "‚ùå File has trailing whitespace: $file"
                      has_trailing=true
                    fi
                  done

                  if [ "$has_trailing" = true ]; then
                    echo "‚ùå Trailing whitespace check failed!"
                    exit 1
                  fi

                  echo "‚úÖ Trailing whitespace check passed!"

            - name: Validate HTML Syntax
              run: |
                  echo "üîç Validating HTML syntax..."

                  # Install HTML validator
                  npm install -g html-validate

                  # Create HTML validate config
                  cat > .htmlvalidate.json << 'EOF'
                  {
                    "extends": ["html-validate:recommended"],
                    "rules": {
                      "void-style": "off",
                      "no-inline-style": "off",
                      "require-sri": "off"
                    }
                  }
                  EOF

                  # Validate all HTML files
                  html_files=$(find . -name "*.html" -not -path "./node_modules/*")

                  if [ -n "$html_files" ]; then
                    html-validate $html_files || echo "‚ö†Ô∏è  HTML validation warnings found"
                  fi

                  echo "‚úÖ HTML syntax check completed!"

            - name: Check File Sizes
              run: |
                  echo "üîç Checking file sizes..."

                  # Check for files larger than 500KB
                  large_files=$(find . -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) \
                                -not -path "./node_modules/*" \
                                -not -path "./.git/*" \
                                -size +500k)

                  if [ -n "$large_files" ]; then
                    echo "‚ö†Ô∏è  Large files detected (>500KB):"
                    echo "$large_files"
                    echo "Consider optimizing or splitting these files."
                  else
                    echo "‚úÖ All files are within size limits"
                  fi

            - name: Check for Console Logs
              run: |
                  echo "üîç Checking for console.log statements..."

                  js_files=$(find . -name "*.js" -not -path "./node_modules/*")

                  has_console=false

                  for file in $js_files; do
                    if grep -n "console\.log" "$file" | grep -v "console.error"; then
                      echo "‚ö†Ô∏è  Found console.log in: $file"
                      has_console=true
                    fi
                  done

                  if [ "$has_console" = true ]; then
                    echo "‚ö†Ô∏è  Console.log statements found. Consider removing for production."
                  else
                    echo "‚úÖ No console.log statements found"
                  fi

            - name: Validate JSON Files
              run: |
                  echo "üîç Validating JSON files..."

                  json_files=$(find . -name "*.json" -not -path "./node_modules/*")

                  for file in $json_files; do
                    echo "üìÑ Validating: $file"
                    if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
                      echo "‚ùå Invalid JSON in: $file"
                      exit 1
                    fi
                  done

                  echo "‚úÖ All JSON files are valid!"

            - name: Check for TODO Comments
              run: |
                  echo "üîç Checking for TODO comments..."

                  files=$(find . -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) \
                          -not -path "./node_modules/*")

                  todos=$(grep -rn "TODO\|FIXME\|XXX\|HACK" $files 2>/dev/null || true)

                  if [ -n "$todos" ]; then
                    echo "‚ö†Ô∏è  TODO comments found:"
                    echo "$todos"
                    echo ""
                    echo "Consider creating GitHub issues for these items."
                  else
                    echo "‚úÖ No TODO comments found"
                  fi

            - name: Check Copyright Headers
              run: |
                  echo "üîç Checking for copyright/license information..."

                  if [ ! -f "LICENSE" ]; then
                    echo "‚ö†Ô∏è  No LICENSE file found. Consider adding one."
                  else
                    echo "‚úÖ LICENSE file exists"
                  fi

            - name: Summary
              if: success()
              run: |
                  echo ""
                  echo "=================================="
                  echo "‚úÖ CODE QUALITY CHECKS PASSED! üéâ"
                  echo "=================================="
                  echo ""
                  echo "‚úÖ Indentation checked"
                  echo "‚úÖ Line endings checked"
                  echo "‚úÖ Trailing whitespace checked"
                  echo "‚úÖ HTML syntax validated"
                  echo "‚úÖ File sizes checked"
                  echo "‚úÖ Console logs checked"
                  echo "‚úÖ JSON files validated"
                  echo "‚úÖ TODO comments checked"
                  echo "‚úÖ License checked"
                  echo ""

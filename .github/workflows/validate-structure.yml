name: File Structure Validation

on:
    pull_request:
        branches: [main, develop]
    push:
        branches: [main, develop]

jobs:
    validate-structure:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Validate Root Structure
              run: |
                  echo "üîç Validating root directory structure..."

                  # Check required root files
                  required_files=(
                    "index.html"
                    "index.js"
                    "common.css"
                    "home.css"
                    "README.md"
                    "STRUCTURE.md"
                    "sitemap.xml"
                    "robots.txt"
                    "404.html"
                    ".editorconfig"
                    ".gitignore"
                  )

                  for file in "${required_files[@]}"; do
                    if [ ! -f "$file" ]; then
                      echo "‚ùå Missing required file: $file"
                      exit 1
                    else
                      echo "‚úÖ Found: $file"
                    fi
                  done

                  # Check required directories
                  required_dirs=(
                    ".github"
                    ".vscode"
                    "tools"
                    "fonts"
                  )

                  for dir in "${required_dirs[@]}"; do
                    if [ ! -d "$dir" ]; then
                      echo "‚ùå Missing required directory: $dir"
                      exit 1
                    else
                      echo "‚úÖ Found: $dir/"
                    fi
                  done

                  echo "‚úÖ Root structure validation passed!"

            - name: Validate VS Code Configuration
              run: |
                  echo "üîç Validating VS Code configuration..."

                  vscode_files=(
                    ".vscode/settings.json"
                    ".vscode/extensions.json"
                    ".vscode/keybindings.json"
                  )

                  for file in "${vscode_files[@]}"; do
                    if [ ! -f "$file" ]; then
                      echo "‚ùå Missing VS Code config: $file"
                      exit 1
                    else
                      echo "‚úÖ Found: $file"
                    fi
                  done

                  echo "‚úÖ VS Code configuration validation passed!"

            - name: Validate GitHub Templates
              run: |
                  echo "üîç Validating GitHub issue templates..."

                  github_files=(
                    ".github/ISSUE_TEMPLATE/new-tool-request.md"
                    ".github/ISSUE_TEMPLATE/bug-report.md"
                    ".github/ISSUE_TEMPLATE/feature-request.md"
                    ".github/ISSUE_TEMPLATE/config.yml"
                  )

                  for file in "${github_files[@]}"; do
                    if [ ! -f "$file" ]; then
                      echo "‚ùå Missing GitHub template: $file"
                      exit 1
                    else
                      echo "‚úÖ Found: $file"
                    fi
                  done

                  echo "‚úÖ GitHub templates validation passed!"

            - name: Validate Tool Structure
              run: |
                  echo "üîç Validating tools directory structure..."

                  # Check if tools directory exists
                  if [ ! -d "tools" ]; then
                    echo "‚ùå tools/ directory not found"
                    exit 1
                  fi

                  # Get all tool directories
                  tool_dirs=$(find tools -mindepth 1 -maxdepth 1 -type d)

                  if [ -z "$tool_dirs" ]; then
                    echo "‚ö†Ô∏è  No tools found in tools/ directory"
                    exit 0
                  fi

                  # Validate each tool has required files
                  for tool_dir in $tool_dirs; do
                    tool_name=$(basename "$tool_dir")
                    echo "üìÅ Validating tool: $tool_name"

                    required_tool_files=(
                      "$tool_dir/index.html"
                      "$tool_dir/style.css"
                      "$tool_dir/app.js"
                    )

                    for file in "${required_tool_files[@]}"; do
                      if [ ! -f "$file" ]; then
                        echo "‚ùå Missing required file in $tool_name: $(basename $file)"
                        exit 1
                      else
                        echo "  ‚úÖ Found: $(basename $file)"
                      fi
                    done
                  done

                  echo "‚úÖ All tools have correct structure!"

            - name: Validate HTML Files
              run: |
                  echo "üîç Validating HTML files..."

                  # Find all HTML files
                  html_files=$(find . -name "*.html" -not -path "./node_modules/*")

                  for file in $html_files; do
                    echo "üìÑ Checking: $file"

                    # Check for required meta tags in tool HTML files
                    if [[ $file == *"/tools/"* ]]; then
                      if ! grep -q '<meta charset="UTF-8">' "$file"; then
                        echo "‚ùå Missing UTF-8 charset in $file"
                        exit 1
                      fi

                      if ! grep -q '<meta name="viewport"' "$file"; then
                        echo "‚ùå Missing viewport meta tag in $file"
                        exit 1
                      fi

                      if ! grep -q 'common.css' "$file"; then
                        echo "‚ùå Missing common.css reference in $file"
                        exit 1
                      fi

                      echo "  ‚úÖ HTML validation passed"
                    fi
                  done

                  echo "‚úÖ All HTML files validated!"

            - name: Validate CSS Files
              run: |
                  echo "üîç Validating CSS files..."

                  # Check if common.css has required CSS variables
                  if [ -f "common.css" ]; then
                    required_vars=(
                      "--primary-colour"
                      "--body-bg"
                      "--card-bg"
                      "--accent-color"
                      "--text-secondary"
                      "--border-color"
                    )

                    for var in "${required_vars[@]}"; do
                      if ! grep -q "$var" "common.css"; then
                        echo "‚ùå Missing CSS variable in common.css: $var"
                        exit 1
                      fi
                    done

                    echo "‚úÖ common.css has all required variables"
                  fi

                  echo "‚úÖ CSS validation passed!"

            - name: Validate JavaScript Files
              run: |
                  echo "üîç Validating JavaScript files..."

                  # Find all JS files in tools
                  js_files=$(find tools -name "app.js" 2>/dev/null || true)

                  for file in $js_files; do
                    echo "üìÑ Checking: $file"

                    # Basic validation - check file is not empty
                    if [ ! -s "$file" ]; then
                      echo "‚ùå Empty JavaScript file: $file"
                      exit 1
                    fi

                    echo "  ‚úÖ JavaScript file validated"
                  done

                  echo "‚úÖ JavaScript validation passed!"

            - name: Summary
              if: success()
              run: |
                  echo ""
                  echo "=================================="
                  echo "‚úÖ ALL VALIDATIONS PASSED! üéâ"
                  echo "=================================="
                  echo ""
                  echo "‚úÖ Root structure validated"
                  echo "‚úÖ VS Code configuration validated"
                  echo "‚úÖ GitHub templates validated"
                  echo "‚úÖ Tool structure validated"
                  echo "‚úÖ HTML files validated"
                  echo "‚úÖ CSS files validated"
                  echo "‚úÖ JavaScript files validated"
                  echo ""
